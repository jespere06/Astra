# ASTRA Stack
networks:
  astra-net:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  qdrant_data:
    driver: local
  minio_data:
    driver: local
  huggingface_cache:
    driver: local
  localstack_data:
    driver: local

services:
  # ==========================================
  # INFRASTRUCTURE (Data & Cache)
  # ==========================================

  # 1. Relational Database (PostgreSQL)
  postgres:
    image: postgres:15-alpine
    container_name: astra-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: astra
      POSTGRES_PASSWORD: astra_secure_pass
      POSTGRES_DB: astra_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - astra-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U astra -d astra_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Session Cache (Redis)
  redis:
    image: redis:7-alpine
    container_name: astra-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - astra-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 3. Vector Database (Qdrant)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: astra-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - astra-net
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/6333'"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 4. Object Storage (MinIO)
  minio:
    image: minio/minio:latest
    container_name: astra-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: astra_minio_pass
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - astra-net
    healthcheck:
      test: ["CMD-SHELL", "test -f /data/.minio.sys/format.json"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # 4.1 MinIO Provisioner (Buckets Init)
  setup-minio:
    image: minio/mc:latest
    container_name: astra-setup-minio
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 admin astra_minio_pass;
      /usr/bin/mc mb myminio/astra-raw --ignore-existing;
      /usr/bin/mc mb myminio/astra-processed --ignore-existing;
      /usr/bin/mc mb myminio/astra-templates --ignore-existing;
      /usr/bin/mc mb myminio/astra-models --ignore-existing;
      /usr/bin/mc mb myminio/astra-guard-vault --ignore-existing;
      /usr/bin/mc mb myminio/astra-audio-vault --ignore-existing;
      /usr/bin/mc anonymous set public myminio/astra-raw;
      /usr/bin/mc anonymous set public myminio/astra-templates;
      exit 0;
      "
    networks:
      - astra-net

  # NUEVO: LocalStack para simular AWS KMS (Encryption)
  localstack:
    image: localstack/localstack:latest
    container_name: astra-localstack
    ports:
      - "4566:4566"            # Edge Port
    environment:
      - SERVICES=kms,s3        # Solo levantamos lo necesario
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - localstack_data:/var/lib/localstack
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - astra-net

  # Script de inicializaciÃ³n de infraestructura GUARD
  setup-guard:
    image: amazon/aws-cli
    container_name: astra-setup-guard
    depends_on:
      - minio
      - localstack
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=astra_minio_pass
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: ["/bin/sh", "-c"]
    # Script para crear el bucket con Object Lock habilitado
    command: >
      "
      echo 'Waiting for MinIO...' && sleep 5;
      aws --endpoint-url http://minio:9000 s3api create-bucket --bucket astra-guard-vault --object-lock-enabled-for-bucket;
      echo 'Bucket WORM created.';
      "
    networks:
      - astra-net

  # ==========================================
  # APPLICATION SERVICES (Microservices)
  # ==========================================

  # A. Orchestrator (The Brain)
  astra-orchestrator:
    build: 
      context: ./services/astra-orchestrator
    container_name: astra-orchestrator
    platform: linux/arm64
    ports:
      - "8001:8000"
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://astra:astra_secure_pass@postgres:5432/astra_db
      - CORE_SERVICE_URL=http://astra-core:8000
      - INGEST_SERVICE_URL=http://astra-ingest:8000
      - BUILDER_SERVICE_URL=http://astra-builder:8000
      - S3_ENDPOINT_URL=http://minio:9000
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=astra_minio_pass
      - RUNPOD_API_KEY=${RUNPOD_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - astra-net

  # B. Core (Semantic Engine)
  astra-core:
    build: 
      context: ./services/astra-core
    container_name: astra-core
    platform: linux/arm64
    ports:
      - "8002:8000"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_HOST=redis
      - S3_ENDPOINT_URL=http://minio:9000
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=astra_minio_pass
      - WHISPER_DEVICE=cpu
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
    volumes:
      - huggingface_cache:/root/.cache/huggingface
    depends_on:
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - astra-net

  # C. Ingest (Document Processor)
  astra-ingest:
    build: 
      context: ./modules/astra-ingest
    container_name: astra-ingest
    platform: linux/arm64
    ports:
      - "8003:8000"
    environment:
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=admin
      - MINIO_SECRET_KEY=astra_minio_pass
    depends_on:
      minio:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - astra-net

  # D. Builder (Document Generator)
  astra-builder:
    build: 
      context: ./services/astra-builder
    container_name: astra-builder
    platform: linux/arm64
    ports:
      - "8004:8000"
    environment:
      - MINIO_ENDPOINT=minio:9000
    networks:
      - astra-net

  # E. Guard (The Vault)
  astra-guard:
    build:
      context: ./services/astra-guard
    container_name: astra-guard
    platform: linux/arm64
    ports:
      - "8005:8000"
    environment:
      - DATABASE_URL=postgresql://astra:astra_secure_pass@postgres:5432/astra_db
      - KMS_ENDPOINT_URL=http://localstack:4566
      - S3_ENDPOINT_URL=http://minio:9000
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=astra_minio_pass
      - GUARD_VAULT_BUCKET=astra-guard-vault
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      localstack:
        condition: service_started
    networks:
      - astra-net

  # F. Learn (Continuous Improvement)
  astra-learn:
    build:
      context: ./services/astra-learn
    container_name: astra-learn
    platform: linux/arm64
    ports:
      - "8006:8000"
    environment:
      - DATABASE_URL=postgresql://astra:astra_secure_pass@postgres:5432/astra_db
      - REDIS_URL=redis://redis:6379/0
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=astra_minio_pass
      - RUNPOD_API_KEY=${RUNPOD_API_KEY}
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - astra-net

  # I. Tenant Config Service
  tenant-config-service:
    build:
      context: ./services/tenant-config-service
    container_name: astra-tenant-config
    platform: linux/arm64
    ports:
      - "8080:8080"
    networks:
      - astra-net

  # J. Worker (Batch Processing) - COMENTADO PARA LOCAL DEV (Usar RunPod)
  # astra-worker:
  #   profiles: ["gpu-worker"]
  #   build:
  #     context: ./services/astra-worker
  #   container_name: astra-worker
  #   platform: linux/arm64
  #   environment:
  #     - S3_ENDPOINT_URL=http://minio:9000
  #     - AWS_ACCESS_KEY_ID=admin
  #     - AWS_SECRET_ACCESS_KEY=astra_minio_pass
  #   depends_on:
  #     - minio
  #   networks:
  #     - astra-net

  # G. Dashboard (Experience Layer)
  astra-dashboard:
    build:
      context: ./services/astra-dashboard
    container_name: astra-dashboard
    platform: linux/arm64
    ports:
      - "3000:3000"
    volumes:
      - ./services/astra-dashboard:/app
      - /app/node_modules
    environment:
      - VITE_API_ORCHESTRATOR=http://astra-orchestrator:8000
      - VITE_API_INGEST=http://astra-ingest:8000
      - VITE_API_LEARNING=http://astra-learn:8000
    depends_on:
      - astra-orchestrator
      - astra-ingest
    networks:
      - astra-net

  # H. Proxy / Gateway
  proxy:
    image: nginx:alpine
    container_name: astra-proxy
    ports:
      - "80:80"
    volumes:
      - ./infra/local/proxy/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - astra-orchestrator
      - astra-guard
      - astra-learn
    networks:
      - astra-net
